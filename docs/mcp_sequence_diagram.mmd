sequenceDiagram
    autonumber
    actor User
    participant UI as Interface
    participant MCP as MCP Server
    participant EXT as Arg Extractor
    participant RTR as Router
    participant LDR as Loader
    participant PLN as Planner LLM
    participant TOOL as Tool
    participant UP as Upstream
    participant SUM as Summarizer LLM

    User->>UI: Ask a question
    UI->>MCP: POST /mcp/tools/call (query, namespace?)

    MCP->>EXT: Extract hints
    EXT-->>MCP: hints (task_id/job_id/site/...) 
    MCP->>RTR: Choose routing mode

    alt Fast-path (deterministic)
        RTR-->>MCP: tool_name + arguments
    else Planner (conditional)
        RTR-->>MCP: Need planning
        MCP->>LDR: List/resolve available tools
        LDR-->>MCP: Tool catalog (name, description, schema)
        MCP->>PLN: Plan(question, hints, tools, plan_schema)
        PLN-->>MCP: Plan JSON
        MCP->>RTR: Validate plan
        RTR-->>MCP: tool_calls[]
    end

    loop For each tool call
        MCP->>LDR: Resolve tool implementation
        LDR-->>MCP: Resolved tool
        MCP->>TOOL: Validate args vs inputSchema
        MCP->>TOOL: call(arguments)
        TOOL->>UP: Query upstream service
        UP-->>TOOL: Structured data
        TOOL-->>MCP: {text, evidence}
    end

    alt Summarization enabled
        MCP->>SUM: Summarize(question + evidence)
        SUM-->>MCP: answer_text
        MCP-->>UI: answer_text + evidence
    else Summarization disabled
        MCP-->>UI: tool text + evidence
    end

    UI-->>User: Render answer (+ evidence/debug)
